import sys
import cv2
import numpy as np
from mss import mss
import tkinter as tk
import ctypes
import threading

try:
    import keyboard
    _HAS_KEYBOARD = True
except ImportError:
    _HAS_KEYBOARD = False
    print("[WARN] 'keyboard' library not found. Install with: pip install keyboard")
    sys.exit(1)

from PyQt5.QtWidgets import QApplication, QLabel, QWidget
from PyQt5.QtGui import QPixmap, QImage, QCursor
from PyQt5.QtCore import Qt, QTimer

print("[INFO] Starting combined magnifier and crosshair overlay...")

# ===== MAGNIFIER CONFIGURATION =====
SCALE = 2  # Magnification factor
RADIUS = 120  # Radius of the lens
TIMER_MS = 33  # ~30 FPS
WINDOW_SIZE = 400  # Fixed window size
sct = mss()  # Screen capture object

# ===== CROSSHAIR CONFIGURATION =====
dot_color = "red" # Color of the crosshair dot
dot_size = 1 # Size of the crosshair dot
auto_detect_key = "up"  # hotkey to start auto-detection
exit_key = "down"  # hotkey to exit application

# ===== YELLOW DETECTION CONFIGURATION =====
DETECTION_CHECK_MS = 100  # Check every 100ms for yellow color
mag_detection_pos = (1718, 877)  # Fixed position for magazine indicator


def detect_yellow_in_region():
    """Detect if yellow/gold color exists at position (918, 898)"""
    x, y = mag_detection_pos
    
    # Capture a small region around the target pixel (5x5 area for reliability)
    region = {
        "left": x - 2,
        "top": y - 2,
        "width": 5,
        "height": 5,
    }
    
    try:
        # Capture the region
        sct_img = sct.grab(region)
        frame = np.array(sct_img)[..., :3]  # BGR format
        
        # Convert BGR to HSV for better color detection
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
        
        # Define orange-yellow/gold color range in HSV
        lower_yellow1 = np.array([15, 80, 80])   # Lighter yellow-orange
        upper_yellow1 = np.array([35, 255, 255])
        
        # Also check for darker gold/orange tones
        lower_yellow2 = np.array([10, 100, 100])
        upper_yellow2 = np.array([30, 255, 200])
        
        # Create masks for both ranges
        mask1 = cv2.inRange(hsv, lower_yellow1, upper_yellow1)
        mask2 = cv2.inRange(hsv, lower_yellow2, upper_yellow2)
        
        # Combine masks
        mask = cv2.bitwise_or(mask1, mask2)
        
        # Count yellow pixels
        yellow_pixels = cv2.countNonZero(mask)
        
        # Debug: print pixel count occasionally
        import random
        if random.random() < 0.01:  # Print 1% of the time to avoid spam
            print(f"[DEBUG] Yellow pixels detected at ({x}, {y}): {yellow_pixels}/25")
        
        # If more than 3 pixels in the 5x5 area are yellow, consider gun equipped
        return yellow_pixels > 3
        
    except Exception as e:
        print(f"[WARN] Detection failed: {e}")
        return False


# ===== MAGNIFIER CLASSES =====
class MagnifiedView(QWidget):
    """Shows the magnified image; draggable and stays on top."""
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"Magnified View {SCALE}x")
        self.setWindowFlags(Qt.WindowStaysOnTopHint)
        
        self._drag_pos = None
        
        self.label = QLabel(self)
        self.label.setScaledContents(True)
        self.setFixedSize(WINDOW_SIZE, WINDOW_SIZE)
        self.label.resize(self.size())

    def update_image(self, frame_bgr):
        frame_rgb = cv2.cvtColor(frame_bgr, cv2.COLOR_BGR2RGB)
        h, w, ch = frame_rgb.shape
        qimg = QImage(frame_rgb.data, w, h, ch * w, QImage.Format_RGB888).copy()
        self.label.setPixmap(QPixmap.fromImage(qimg))

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            self._drag_pos = event.globalPos()

    def mouseMoveEvent(self, event):
        if self._drag_pos:
            self.move(self.pos() + event.globalPos() - self._drag_pos)
            self._drag_pos = event.globalPos()

    def mouseReleaseEvent(self, event):
        self._drag_pos = None


class LensWindow(QWidget):
    """Transparent border that follows cursor."""
    def __init__(self, magnified_window):
        super().__init__()
        self.magnified_window = magnified_window

        self.setWindowFlags(
            Qt.FramelessWindowHint | 
            Qt.WindowStaysOnTopHint | 
            Qt.WindowTransparentForInput
        )
        self.setAttribute(Qt.WA_TranslucentBackground)

        self.label = QLabel(self)
        self.label.setScaledContents(True)
        self.label.setStyleSheet("background: transparent;")
        self.label.setAttribute(Qt.WA_TranslucentBackground)

        self.setFixedSize(RADIUS * 2, RADIUS * 2)
        self.label.resize(self.size())

        # Pre-create the border overlay once
        self.border_overlay = np.zeros((RADIUS * 2, RADIUS * 2, 4), dtype=np.uint8)
        cv2.rectangle(self.border_overlay, (0, 0), (RADIUS * 2 - 1, RADIUS * 2 - 1), 
                     (0, 255, 0, 255), 3)
        
        w, h = RADIUS * 2, RADIUS * 2
        qimg = QImage(self.border_overlay.data, w, h, 4 * w, QImage.Format_RGBA8888).copy()
        self.border_pixmap = QPixmap.fromImage(qimg)
        self.label.setPixmap(self.border_pixmap)

        self.timer = QTimer()
        self.timer.timeout.connect(self.update_frame)
        self.timer.start(TIMER_MS)

    def update_frame(self):
        pos = QCursor.pos()
        x, y = pos.x(), pos.y()
        self.move(x - RADIUS, y - RADIUS)

        mon = {
            "left": x - RADIUS,
            "top": y - RADIUS,
            "width": RADIUS * 2,
            "height": RADIUS * 2,
        }

        try:
            sct_img = sct.grab(mon)
            frame = np.array(sct_img)[..., :3]
            magnified = cv2.resize(frame, None, fx=SCALE, fy=SCALE, 
                                  interpolation=cv2.INTER_LINEAR)
            self.magnified_window.update_image(magnified)
        except Exception as e:
            print(f"[WARN] Capture failed: {e}")


# ===== CROSSHAIR FUNCTIONS =====
crosshair_root = None
crosshair_canvas = None
crosshair_dot = None
crosshair_visible = True
crosshair_position_set = False


def setup_crosshair():
    """Setup crosshair overlay in background thread"""
    global crosshair_root, crosshair_canvas, crosshair_dot, crosshair_visible, crosshair_position_set

    # Capture mouse position
    
    x = 960
    y = 540
    

    # Create transparent overlay
    crosshair_root = tk.Tk()
    crosshair_root.overrideredirect(True)
    crosshair_root.attributes('-topmost', True)
    crosshair_root.attributes('-transparentcolor', 'white')

    screen_width = crosshair_root.winfo_screenwidth()
    screen_height = crosshair_root.winfo_screenheight()
    crosshair_root.geometry(f"{screen_width}x{screen_height}+0+0")

    crosshair_canvas = tk.Canvas(crosshair_root, bg='white', highlightthickness=0)
    crosshair_canvas.pack(fill="both", expand=True)

    # Draw the dot
    r = dot_size / 2
    crosshair_dot = crosshair_canvas.create_oval(x - r, y - r, x + r, y + r, 
                                                  fill=dot_color, outline=dot_color)

    crosshair_root.update_idletasks()

    # Make window click-through
    hwnd = ctypes.windll.user32.GetParent(crosshair_root.winfo_id())
    GWL_EXSTYLE = -20
    WS_EX_TRANSPARENT = 0x20
    WS_EX_LAYERED = 0x80000
    styles = ctypes.windll.user32.GetWindowLongW(hwnd, GWL_EXSTYLE)
    ctypes.windll.user32.SetWindowLongW(hwnd, GWL_EXSTYLE, 
                                        styles | WS_EX_TRANSPARENT | WS_EX_LAYERED)

    crosshair_position_set = True
    
    crosshair_root.mainloop()


# ===== VISIBILITY CONTROLLER =====
class VisibilityController:
    """Controls visibility of magnifier and crosshair based on yellow detection"""
    def __init__(self, magnified_window, lens_window):
        self.magnified_window = magnified_window
        self.lens_window = lens_window
        self.is_showing = True
        self.auto_detect_enabled = False  # Start with auto-detection OFF
        
        self.timer = QTimer()
        self.timer.timeout.connect(self.check_and_update)
        self.timer.start(DETECTION_CHECK_MS)
    
    def toggle_auto_detect(self):
        """Toggle auto-detection on/off"""
        self.auto_detect_enabled = not self.auto_detect_enabled
        if self.auto_detect_enabled:
            print("[INFO] Auto-detection ENABLED - magnifier/crosshair will auto-hide when gun is holstered")
        else:
            print("[INFO] Auto-detection DISABLED - magnifier/crosshair will stay visible")
            # When disabled, make sure everything is visible
            if not self.is_showing:
                self.magnified_window.show()
                self.lens_window.show()
                if crosshair_position_set and crosshair_canvas and crosshair_dot and crosshair_visible:
                    crosshair_canvas.itemconfigure(crosshair_dot, state='normal')
                self.is_showing = True
    
    def check_and_update(self):
        """Check for yellow and update visibility"""
        if not self.auto_detect_enabled:
            return  # Skip detection if disabled
        
        yellow_detected = detect_yellow_in_region()
        
        if yellow_detected and not self.is_showing:
            # Show magnifier
            self.magnified_window.show()
            self.lens_window.show()
            
            # Show crosshair
            if crosshair_position_set and crosshair_canvas and crosshair_dot and crosshair_visible:
                crosshair_canvas.itemconfigure(crosshair_dot, state='normal')
            
            self.is_showing = True
            print("[INFO] Gun equipped - showing magnifier and crosshair")
            
        elif not yellow_detected and self.is_showing:
            # Hide magnifier
            self.magnified_window.hide()
            self.lens_window.hide()
            
            # Hide crosshair
            if crosshair_position_set and crosshair_canvas and crosshair_dot:
                crosshair_canvas.itemconfigure(crosshair_dot, state='hidden')
            
            self.is_showing = False
            print("[INFO] Gun holstered - hiding magnifier and crosshair")


# ===== MAIN APPLICATION =====
def main():
    # Start PyQt5 application
    app = QApplication(sys.argv)

    magnified_window = MagnifiedView()
    lens_window = LensWindow(magnified_window)

    magnified_window.show()
    lens_window.show()

    # Start visibility controller
    visibility_controller = VisibilityController(magnified_window, lens_window)

    # Start crosshair in background thread
    crosshair_thread = threading.Thread(target=setup_crosshair, daemon=True)
    crosshair_thread.start()

    # Global hotkeys
    def do_exit():
        print("[INFO] Exiting...")
        keyboard.unhook_all()
        if crosshair_root:
            crosshair_root.quit()
        app.quit()
        sys.exit(0)

    keyboard.add_hotkey(exit_key, do_exit)
    keyboard.add_hotkey(auto_detect_key, visibility_controller.toggle_auto_detect)

    print(f"[INFO] Magnifier active (drag to move window)")
    print(f"[INFO] Auto-detection set to check position (1718, 877) for magazine indicator")
    print(f"[INFO] Auto-detection is OFF by default - press {auto_detect_key} to enable")
    print(f"[INFO] Global hotkeys:")
    print(f"  - {auto_detect_key}: Toggle auto-detection ON/OFF")
    print(f"  - {exit_key}: Exit application")
    print("[INFO] Running...")

    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
